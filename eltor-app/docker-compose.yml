services:
  # app_proxy:
  #   environment:
  #     APP_HOST: $APP_HOST
  #     APP_PORT: 5175
  #     PROXY_AUTH_ADD: "false"
  #   networks:
  #     - default
  web:
    image: eltor/eltor-app:latest
    init: true
    stop_grace_period: 1m
    ports:
      - "0.0.0.0:5174:5174"   # Backend API - explicitly bind to all interfaces
      - "0.0.0.0:5173:5173"   # Frontend web server - explicitly bind to all interfaces
      - "0.0.0.0:9740:9740"   # Lightning node - explicitly bind to all interfaces
      - "0.0.0.0:18058:18058" # Tor SOCKS proxy - explicitly bind to all interfaces
      - "0.0.0.0:9996:9996"   # Tor relay OR port
    volumes:
      - ${APP_DATA_DIR}/data/phoenix:/home/user/.phoenix
      - ${APP_CORE_LIGHTNING_DATA_DIR}:/home/user/.lightning:ro
    user: "1000:1000"
    env_file:
      - ${APP_CORE_LIGHTNING_DATA_DIR}/.commando-env
    environment:
      - RUST_LOG=info
      - BACKEND_PORT=${BACKEND_PORT:-5174}
      - FRONTEND_PORT=${FRONTEND_PORT:-5173}
      - USE_PHOENIXD_EMBEDDED=${USE_PHOENIXD_EMBEDDED:-true}
      - PHOENIX_PORT=${PHOENIX_PORT:-9740}
      - LN_IMPLEMENTATION=${LN_IMPLEMENTATION:-"CLN"}
      - LN_SERVER_URL=${LN_SERVER_URL:-"https://$APP_CORE_LIGHTNING_DAEMON_IP:$CORE_LIGHTNING_REST_PORT"}
      - RUNE_PATH=${RUNE_PATH:-"/home/user/.lightning/.commando-env"}
      - ELTORRC_PATH="/home/user/code/eltor-app/backend/bin/data/torrc"
      - TOR_RELAY_PAYMENT_LIGHTNING_NODE_CONFIG="type=cln url=$LN_SERVER_URL password=${LIGHTNING_RUNE} default=true"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${BACKEND_PORT:-5174}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - default

networks:
  default:
    name: umbrel_main_network
    external: true
    